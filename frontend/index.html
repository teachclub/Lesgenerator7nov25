<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masterprompt Geschiedenis (Debug)</title> <style>
        /* CSS blijft hetzelfde */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #2c3e50; }
        h1 { border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.8em; }
        .inleiding { background-color: #eaf2f8; padding: 15px; border-radius: 5px; margin-bottom: 25px; border-left: 5px solid #3498db; line-height: 1.6; }
        .inleiding a { color: #2980b9; text-decoration: none; }
        .inleiding a:hover { text-decoration: underline; }
        .controls, .suggestion-cards, .output { margin-bottom: 25px; padding: 20px; border: 1px solid #dcdcdc; border-radius: 6px; background-color: #fdfdfd; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.95em; color: #555; }
        select, input[type="text"] { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em; }
        select:disabled { background-color: #eee; cursor: not-allowed; }
        .optional-label { font-weight: normal; font-size: 0.9em; color: #777; margin-top: -10px; margin-bottom: 5px;}
        .suggestion-cards h3 { margin-top: 0; }
        .suggestion-card { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease-in-out; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .suggestion-card:hover { border-color: #3498db; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .suggestion-card.selected { border-color: #e74c3c; background: #fff7f5; box-shadow: 0 0 0 2px #e74c3c inset; }
        .card-title { font-weight: bold; color: #2980b9; margin-bottom: 8px; font-size: 1.1em;}
        .card-hoofdvraag { font-style: italic; margin-top: 5px; margin-bottom: 12px; color: #555;}
        .card-leeropbrengst { margin-top: 10px; font-size: 0.9em; color: #444; }
        .card-leeropbrengst ul { padding-left: 18px; margin-top: 5px; list-style: disc; }
        .button-group { margin-top: 20px; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 18px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; font-size: 1em; margin-right: 10px;}
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        textarea { width: 100%; min-height: 400px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; margin-top: 15px; font-family: monospace; font-size: 0.9em; line-height: 1.5; }
        .error { color: #c0392b; font-weight: bold; background-color: #f9e9e9; padding: 10px; border-radius: 4px; border: 1px solid #e74c3c; margin-top: 15px;}
        #message { margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Masterprompt Geschiedenis ðŸ‡³ðŸ‡± (Debug Mode)</h1> <div class="inleiding">
             Korte inleiding voor geschiedenisdocenten: deze tool genereert een panklare les met echte bronnen rond presentisme en historisch redeneren. Je krijgt na je keuze een complete opdracht in de stijl van <i>Het Vreemde Verleden</i>, inclusief docenteninstructie (WATâ€“HOEâ€“WAAROM), leerlingenteksten, bronvragen, tabellen en reflectie. Feedback is welkom via <a href="mailto:c.koole@spinozalyceum.nl">c.koole@spinozalyceum.nl</a>.
        </div>

        <div class="controls">
             <h2>Parameters</h2>
             <div class="control-group">
                 <label for="tijdvak">Kies tijdvak*</label>
                 <select id="tijdvak">
                     <option value="">â€” Laden... â€”</option>
                 </select>
             </div>
             <div class="control-group">
                 <label for="ka">Kies kenmerkend aspect*</label>
                 <select id="ka" disabled>
                      <option value="">â€” Kies eerst tijdvak â€”</option>
                 </select>
             </div>
             <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
             <div class="control-group">
                  <label for="opt_thema">Optioneel: Thema</label>
                  <input type="text" id="opt_thema" placeholder="Bijv. Reformatie, Verlichting, Koude Oorlog...">
             </div>
              <div class="control-group">
                  <label for="opt_hoofdvraag">Optioneel: Hoofdvraag</label>
                  <input type="text" id="opt_hoofdvraag" placeholder="Formuleer eventueel een eigen hoofdvraag...">
             </div>
              <div class="control-group">
                  <label for="opt_subthemas">Optioneel: Subthemaâ€™s/Dimensies</label>
                  <input type="text" id="opt_subthemas" placeholder="Bijv. economisch, politiek, sociaal-cultureel...">
             </div>
              <div class="control-group">
                  <label for="opt_collecties">Optioneel: Verplichte collecties</label>
                  <input type="text" id="opt_collecties" placeholder="Bijv. Luther, aflaten, Rijksdag van Worms...">
             </div>
             <div class="button-group">
                 <button onclick="fetchSuggestions()" id="fetch-button" disabled>Haal 3 Voorstellen op</button>
             </div>
        </div>

        <div class="suggestion-cards" id="suggestion-cards" style="display: none;">
             <h2>Kies een Lesvoorstel</h2>
             </div>

        <div class="output" id="output-section" style="display: none;">
             <h2>Gegenereerde Les</h2>
             <div class="button-group">
                  <button onclick="downloadLesson()" id="download-button" disabled>Download .txt</button>
             </div>
              <p id="message" class="error" style="display: none;"></p> <textarea id="lesson-output" placeholder="De gegenereerde les (Markdown) verschijnt hier..." readonly></textarea>
        </div>
    </div>

    <script>
        console.log("DEBUG: Scriptblok start."); // <-- DEBUG 1

        const API_BASE = 'https://masterprompt-backend-831952456455.europe-west4.run.app/api';
        let selectedSuggestion = null;
        let sloDataCache = null;

        // --- Element Referenties ---
        const tijdvakSelect = document.getElementById('tijdvak');
        const kaSelect = document.getElementById('ka');
        const fetchButton = document.getElementById('fetch-button');
        const suggestionsContainer = document.getElementById('suggestion-cards');
        // We definiÃ«ren generateButton later, binnen renderSuggestions
        const outputSection = document.getElementById('output-section');
        const downloadButton = document.getElementById('download-button');
        const lessonOutput = document.getElementById('lesson-output');
        const messageElement = document.getElementById('message');
        const optThema = document.getElementById('opt_thema');
        const optHoofdvraag = document.getElementById('opt_hoofdvraag');
        const optSubthemas = document.getElementById('opt_subthemas');
        const optCollecties = document.getElementById('opt_collecties');

        // --- Functies ---
        function showMessage(msg, isError = true) {
             console.log(isError ? "ERROR:" : "INFO:", msg); // Log naar console
            messageElement.textContent = msg;
            messageElement.style.display = msg ? 'block' : 'none';
            messageElement.className = isError ? 'error' : 'info'; // Gebruik info class
        }

        async function fetchTijdvakken() {
            console.log("DEBUG: fetchTijdvakken() gestart..."); // <-- DEBUG 2
            showMessage('');
            fetchButton.disabled = true;
            kaSelect.disabled = true; // Zorg dat KA uit staat tijdens laden
            kaSelect.innerHTML = '<option value="">â€” Laden... â€”</option>';
            tijdvakSelect.innerHTML = '<option value="">â€” Laden... â€”</option>';

            try {
                const response = await fetch(`${API_BASE}/tijdvakken`);
                console.log("DEBUG: fetchTijdvakken() response status:", response.status); // <-- DEBUG 3
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`(${response.status}) ${errorText || 'Kan tijdvakken niet laden.'}`);
                }
                const data = await response.json();
                console.log("DEBUG: fetchTijdvakken() data ontvangen:", data ? Object.keys(data).length + " items" : "geen data"); // <-- DEBUG 4
                sloDataCache = data;

                tijdvakSelect.innerHTML = '<option value="">â€” Maak een keuze â€”</option>';
                for (const key in data) {
                    if (data.hasOwnProperty(key)) { // Extra check
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = data[key].label;
                        tijdvakSelect.appendChild(option);
                    }
                }
                 // Forceer TV5 voor demo
                 tijdvakSelect.value = 'TV5';
                 console.log("DEBUG: Tijdvak TV5 geselecteerd.");
                 updateKA(); // Roep direct aan

                 // Forceer KA21 voor demo
                 kaSelect.value = '21';
                 console.log("DEBUG: KA 21 geselecteerd.");
                 optThema.value = 'Reformatie';
                 optCollecties.value = 'Luther, aflaten, Worms';

                 fetchButton.disabled = false;
                 console.log("DEBUG: fetchTijdvakken() succesvol afgerond.");
                 return data;
            } catch (error) {
                 showMessage(`FOUT bij laden tijdvakken: Kan backend (${API_BASE.replace('/api','')}) niet bereiken. Draait de server? Details: ${error.message}`);
                 console.error("Fout bij fetchTijdvakken:", error);
                 tijdvakSelect.innerHTML = '<option value="">â€” Fout bij laden â€”</option>';
                 kaSelect.innerHTML = '<option value="">â€” Fout bij laden â€”</option>';
                 // throw error; // Gooi fout niet opnieuw, toon bericht
            }
        }

        function updateKA() {
             console.log("DEBUG: updateKA() gestart voor tijdvak:", tijdvakSelect.value);
             if (!sloDataCache) {
                 console.error("SLO data niet geladen in updateKA."); return;
             }
            const tijdvakKey = tijdvakSelect.value;
            kaSelect.innerHTML = '<option value="">â€” Maak een keuze â€”</option>';
            kaSelect.disabled = true;

            if (tijdvakKey && sloDataCache[tijdvakKey] && Array.isArray(sloDataCache[tijdvakKey].kas)) {
                console.log(`DEBUG: Laden ${sloDataCache[tijdvakKey].kas.length} KA's voor ${tijdvakKey}`);
                sloDataCache[tijdvakKey].kas.forEach((kaText) => {
                    if (typeof kaText === 'string') {
                         const option = document.createElement('option');
                         const kaMatch = kaText.match(/^(\d+)\./);
                         if (kaMatch) {
                            option.value = kaMatch[1];
                            option.textContent = kaText;
                            kaSelect.appendChild(option);
                         } else {
                             console.warn("KA Tekst zonder nummer gevonden:", kaText);
                         }
                    }
                });
                if (kaSelect.options.length > 1) {
                    kaSelect.disabled = false;
                    console.log("DEBUG: KA select ingeschakeld.");
                } else {
                     console.log("DEBUG: Geen geldige KA's gevonden, select blijft uit.");
                }
            } else {
                 console.warn(`Geen KA's array gevonden voor tijdvak ${tijdvakKey}`);
            }
        }


        async function fetchSuggestions() {
            console.log("DEBUG: fetchSuggestions() gestart.");
            showMessage('');
            suggestionsContainer.style.display = 'block';
            suggestionsContainer.innerHTML = '<h2>Kies een Lesvoorstel</h2><p>Laden suggesties...</p>'; // Houd titel
            outputSection.style.display = 'none';
            selectedSuggestion = null;
            // Generate button bestaat nog niet hier, wordt in renderSuggestions gemaakt
            downloadButton.disabled = true;
            fetchButton.disabled = true;

            const tijdvak = tijdvakSelect.value;
            const ka = kaSelect.value;
            const thema = optThema.value; // Lees optionele waarden
            const hoofdvraag = optHoofdvraag.value;
            const subthemas = optSubthemas.value;
            const collecties = optCollecties.value;

            // --- DEMO LOGICA ---
            let backendTijdvak = 'TV5';
            let backendKa = '21';
            let backendContext = 'Wittenberg, 1517';
             if (tijdvak !== 'TV5' || ka !== '21') {
                 showMessage('LET OP: Demo backend werkt alleen voor TV5/KA21 (Reformatie). Suggesties hiervoor worden getoond.', false);
             }
             // --- Einde DEMO LOGICA ---

            try {
                console.log("DEBUG: Suggesties aanvragen bij backend:", { backendTijdvak, backendKa, backendContext });
                const response = await fetch(`${API_BASE}/suggest`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tijdvak: backendTijdvak,
                        ka: backendKa,
                        context: backendContext,
                        thema, hoofdvraag, subthemas, collecties, // Stuur optionele mee
                        avoid_ids: []
                    })
                });
                 console.log("DEBUG: Suggesties response status:", response.status);
                 if (!response.ok) {
                     const errorText = await response.text();
                    throw new Error(`(${response.status}) ${errorText || 'Fout bij ophalen suggesties.'}`);
                 }
                const data = await response.json();
                console.log("DEBUG: Suggesties data ontvangen:", data);

                if (!data || !Array.isArray(data.suggestions)) {
                     throw new Error('Ongeldig antwoord van backend (geen suggestions array).');
                }
                if (data.error) { // Check backend specifieke error
                     throw new Error(data.error);
                }

                renderSuggestions(data.suggestions);

            } catch (error) {
                showMessage(`Fout bij ophalen suggesties: ${error.message}`);
                console.error("Fout bij fetchSuggestions:", error);
                suggestionsContainer.innerHTML = '<h2>Kies een Lesvoorstel</h2><p class="error">Kon suggesties niet laden.</p>';
            } finally {
                 fetchButton.disabled = false;
            }
        }

        function renderSuggestions(suggestions) {
             console.log("DEBUG: renderSuggestions() gestart met", suggestions ? suggestions.length : 0, "suggesties.");
            suggestionsContainer.innerHTML = '<h2>Kies een Lesvoorstel</h2>'; // Reset inclusief titel

            if (!suggestions || suggestions.length === 0) {
                suggestionsContainer.innerHTML += '<p>Geen suggesties gevonden.</p>';
                 // Zorg dat de generate knop niet verschijnt als die er al was
                 const existingButton = document.getElementById('generate-button');
                 if (existingButton) existingButton.remove();
                return;
            }

            suggestions.forEach(card => {
                if (typeof card !== 'object' || !card.id || !card.title || !card.head_question || !Array.isArray(card.learning_summary)) {
                    console.error("Ongeldig kaart object in renderSuggestions:", card); return;
                }
                const div = document.createElement('div');
                div.className = 'suggestion-card';
                div.dataset.id = card.id;
                div.innerHTML = `
                    <div class="card-title">${card.title}</div>
                    <div class="card-hoofdvraag">${card.head_question}</div>
                    <div class="card-leeropbrengst"><strong>Leeropbrengst:</strong>
                       <ul>${card.learning_summary.map(l => `<li>${l || ''}</li>`).join('')}</ul>
                    </div>
                     <p style="font-size: 0.8em; color: #888; margin-top: 10px;"><i>ID: ${card.id} | Context: ${card.context || 'n.v.t.'}</i></p>
                `;
                div.onclick = () => {
                    document.querySelectorAll('.suggestion-card').forEach(c => c.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedSuggestion = card;
                     // Activeer generate knop (die hieronder wordt toegevoegd)
                     const genButton = document.getElementById('generate-button');
                     if (genButton) genButton.disabled = false;
                    console.log("DEBUG: Kaart geselecteerd:", selectedSuggestion.id);
                };
                suggestionsContainer.appendChild(div);
            });
             // Voeg generate knop toe NA de kaarten, maar binnen de container
             suggestionsContainer.insertAdjacentHTML('beforeend', `<div class="button-group"><button onclick="generateLesson()" id="generate-button" disabled>Genereer demo</button></div>`);
             console.log("DEBUG: renderSuggestions() klaar, generate knop toegevoegd.");
        }


        async function generateLesson() {
             console.log("DEBUG: generateLesson() gestart voor kaart:", selectedSuggestion ? selectedSuggestion.id : "geen");
            if (!selectedSuggestion || !selectedSuggestion.id) {
                showMessage('Selecteer eerst een geldige voorstelkaart.'); return;
            }

            showMessage('Les aan het genereren...', false);
            outputSection.style.display = 'block';
            lessonOutput.value = 'Genereren...';
             const genButton = document.getElementById('generate-button'); // Haal knop opnieuw op
             if (genButton) genButton.disabled = true;
            downloadButton.disabled = true;


            // --- DEMO LOGICA ---
            let backendCardId = 'A1';
            if (selectedSuggestion.id !== 'A1') {
                 showMessage('LET OP: Demo backend genereert alleen de les voor kaart A1 (Luther).', false);
            }
             // --- Einde DEMO LOGICA ---

            try {
                 console.log("DEBUG: Les generatie aanvragen voor ID:", backendCardId);
                const response = await fetch(`${API_BASE}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: backendCardId }) // Stuur alleen ID
                });
                 console.log("DEBUG: Les generatie response status:", response.status);
                 if (!response.ok) {
                     const errorText = await response.text();
                    throw new Error(`(${response.status}) ${errorText || 'Fout bij genereren les.'}`);
                 }
                const data = await response.json();
                console.log("DEBUG: Les data ontvangen:", data ? "Ja" : "Nee");

                if (data.error) {
                     throw new Error(data.error);
                }
                if (typeof data.lesson !== 'string') {
                     throw new Error('Ongeldige lesdata van backend ontvangen (geen lesson string).');
                }

                lessonOutput.value = data.lesson;
                showMessage('Les succesvol gegenereerd!', false);
                downloadButton.disabled = false;

            } catch (error) {
                showMessage(`Fout bij genereren les: ${error.message}`);
                console.error("Fout bij generateLesson:", error);
                lessonOutput.value = `Fout: ${error.message}`;
            } finally {
                // Heractiveer generate knop alleen als er nog een kaart geselecteerd is
                 if (genButton) genButton.disabled = !selectedSuggestion;
            }
        }

        function downloadLesson() {
            console.log("DEBUG: downloadLesson() gestart.");
            const lessonText = lessonOutput.value;
            if (!lessonText || lessonText.startsWith('Genereren...') || lessonText.startsWith('Fout:')) {
                showMessage('Er is geen geldige les om te downloaden.'); return;
            }
            const kaValue = selectedSuggestion?.ka || kaSelect.value || "onbekend";
            const contextName = selectedSuggestion?.context?.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50) || "les";

            const blob = new Blob([lessonText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Geschiedenis_Lesontwerp_KA${kaValue}_${contextName}.txt`; // .md extensie
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('');
            console.log("DEBUG: Download gestart.");
        }

        // --- Init ---
        // Wacht tot DOM geladen is en start dan fetchTijdvakken
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DEBUG: DOMContentLoaded event afgevuurd."); // <-- DEBUG 0
            fetchTijdvakken(); // Start het laden van tijdvakken
            // Koppel event listener voor tijdvak wijziging
             tijdvakSelect.addEventListener('change', updateKA);
        });

    </script>
</body>
</html>
